<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Онлайн Кинотеатр</title>
    <link rel="stylesheet" href="style.css">
    <script type="module">
        // Импорт необходимых функций из Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAZqT98d7V8gpCeNma7Aos3u7ol5_wOug4",
            authDomain: "games-63197.firebaseapp.com",
            databaseURL: "https://games-63197-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "games-63197",
            storageBucket: "games-63197.appspot.com",
            messagingSenderId: "217470228668",
            appId: "1:217470228668:web:30844724050d278a7358b9"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Функция создания лобби
        function createLobby() {
            const lobbyId = generateLobbyId(); // Генерация уникального ID лобби
            const username = localStorage.getItem('username'); // Получение имени пользователя из localStorage

            const lobbyRef = ref(database, 'lobbies/' + lobbyId);

            // Сохранение данных лобби в Firebase
            set(lobbyRef, {
                host: username,
                players: {
                    [username]: {
                        ready: false
                    }
                }
            }).then(() => {
                alert(`Лобби создано! ID: ${lobbyId}`);
                // Сохранение ID лобби в localStorage и переход на страницу лобби
                localStorage.setItem('lobbyId', lobbyId);
                window.location.href = `LobbyBattleShip.html?lobbyId=${lobbyId}`;
            });
        }

        // Функция генерации уникального ID лобби
        function generateLobbyId() {
            return Math.random().toString(36).substring(2, 9); // Генерация 7-значного ID
        }

        // Функция для присоединения к лобби
        function joinLobby(lobbyId) {
            const username = localStorage.getItem('username'); // Получение имени пользователя из localStorage
            const lobbyRef = ref(database, 'lobbies/' + lobbyId);

            // Получение данных лобби из Firebase
            get(lobbyRef).then((snapshot) => {
                if (snapshot.exists()) {
                    // Добавление игрока в лобби
                    set(ref(database, `lobbies/${lobbyId}/players/${username}`), {
                        ready: false
                    }).then(() => {
                        alert('Вы присоединились к лобби!');
                        localStorage.setItem('lobbyId', lobbyId);
                        window.location.href = `LobbyBattleShip.html?lobbyId=${lobbyId}`;
                    });
                } else {
                    alert('Лобби с таким ID не найдено.');
                }
            });
        }

        // Проверка имени пользователя и отображение соответствующих элементов интерфейса
        document.addEventListener('DOMContentLoaded', () => {
            const username = localStorage.getItem('username');
            const authButton = document.getElementById('auth-button');
            const adminButton = document.querySelector('.admin-button');
            const welcomeMessageContainer = document.querySelector('.auth-buttons');
            const welcomeMessage = document.getElementById('welcome-message');
            const dropdownMenu = document.getElementById('dropdown-menu');
            const logoutButton = document.getElementById('logout-button');

            if (username) {
                authButton?.remove(); // Удаление кнопки регистрации/входа
                const welcomeMsg = document.createElement('span');
                welcomeMsg.textContent = `Добро пожаловать, ${username}!`;
                welcomeMsg.classList.add('username-highlight');
                welcomeMessageContainer.appendChild(welcomeMsg);

                // Показ выпадающего меню при клике на приветственное сообщение
                welcomeMsg.addEventListener('click', () => {
                    dropdownMenu.classList.toggle('show');
                });

                // Обработка выхода
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('username');
                    window.location.reload();
                });

                // Проверка роли пользователя (админ или нет)
                const userRef = ref(database, 'users/' + username);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.role === 'admin') {
                            adminButton.style.display = 'block'; // Показать кнопку для админов
                        } else {
                            adminButton.style.display = 'none'; // Скрыть для обычных пользователей
                        }
                    } else {
                        adminButton.style.display = 'none'; // Если пользователя нет в БД
                    }
                });
            } else {
                adminButton.style.display = 'none'; // Скрытие кнопки, если пользователь не авторизован
            }
        });

        // Привязываем обработчики событий к кнопкам
        const createLobbyButton = document.getElementById('createLobbyButton');
        const joinLobbyButton = document.getElementById('joinLobbyButton');

        createLobbyButton?.addEventListener('click', createLobby);
        joinLobbyButton?.addEventListener('click', () => {
            const lobbyId = document.getElementById('lobbyIdInput').value;
            joinLobby(lobbyId);
        });
    </script>
</head>
<body>
    <header>
        <div class="auth-buttons">
            <a href="account.html" id="auth-button" class="auth-button">Регистрация / Вход</a>
            <div id="welcome-container" class="welcome-container">
                <span id="welcome-message"></span>
                <div id="dropdown-menu" class="dropdown-menu">
                    <button id="logout-button">Выход</button>
                </div>
            </div>
        </div>
        <h1>Test</h1>
    </header>

    <!-- Основной контент -->
    <div class="container">
        <div class="movies-grid" id="movies-grid">
            <div class="movie-card">
                <img src="tic-tac-toe.png" alt="Крестики нолики">
                <h3>Крестики нолиик</h3>
                <button id="createLobbyButton">Создать лобби</button>
                <button id="joinLobbyButton">Присоединиться</button>
                <input type="text" id="lobbyIdInput" placeholder="Введите ID лобби">
            </div>
            <!-- Добавить больше фильмов -->
            <div class="movie-card">
                <img src="poster1.jpg" alt="Новобранец">
                <h3>Пехотинец Серия 20344</h3>
                <button id="createLobbyButton">Создать лобби</button>
                <button id="joinLobbyButton">Присоединиться</button>
                <input type="text" id="lobbyIdInput" placeholder="Введите ID лобби">
            </div>
        </div>
    </div>

    <!-- Кнопка для перехода на admin.html -->
    <div class="admin-button">
        <a href="admin.html">
            <button id="adminPanelButton">Админ панель</button>
        </a>
    </div>
</body>
</html>